# 本番環境動作検証手順

## 🎯 検証概要

本番環境にデプロイした PMO エージェントの全機能を体系的にテストします。

**対象環境**:
- **フロントエンド**: https://pmo-agent-frontend.vercel.app
- **バックエンド**: https://pmo-agent-backend-production-xxxx.up.railway.app

**検証時間**: 約90分

## 📋 事前準備

### 必要なアカウント・情報

- [ ] 本番環境のURL確認済み
- [ ] テスト用Microsoft アカウント準備済み
- [ ] OpenAI API 使用量確認済み（$1程度消費予定）
- [ ] Azure AD アプリ設定完了済み

### テストデータ準備

**テスト用メールアドレス**:
```
メインテスト: test.user@outlook.com  
追加テスト: demo.user@outlook.com
管理者: admin@pmo-agent.com (作成済み)
```

## 🧪 テストカテゴリ

### Phase 1: インフラ・基盤テスト (15分)
### Phase 2: 認証・ユーザー管理テスト (15分)  
### Phase 3: タスク管理機能テスト (20分)
### Phase 4: OpenAI連携テスト (20分)
### Phase 5: Microsoft/Outlook連携テスト (20分)

---

## 🏗️ Phase 1: インフラ・基盤テスト

### 1.1 フロントエンド基盤確認

#### URLアクセステスト

```bash
# ステータスコード確認
curl -I https://pmo-agent-frontend.vercel.app

# レスポンス時間測定
time curl -s https://pmo-agent-frontend.vercel.app > /dev/null
```

**期待される結果**:
```
HTTP/2 200
cache-control: public, max-age=0, must-revalidate
content-type: text/html; charset=utf-8
レスポンス時間: < 2秒
```

#### パフォーマンステスト

1. ブラウザで https://pmo-agent-frontend.vercel.app にアクセス
2. F12 → Network タブでパフォーマンス確認

**確認項目**:
- [ ] **First Paint**: < 1.5秒
- [ ] **Largest Contentful Paint**: < 2.5秒  
- [ ] **Cumulative Layout Shift**: < 0.1
- [ ] **JavaScriptエラー**: なし

### 1.2 バックエンドAPI基盤確認

#### ヘルスチェック

```bash
curl https://pmo-agent-backend-production-xxxx.up.railway.app/health
```

**期待されるレスポンス**:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-20T10:00:00.000Z",
  "version": "1.0.0",
  "environment": "production",
  "database": "connected"
}
```

#### API ドキュメント確認

```bash
curl -I https://pmo-agent-backend-production-xxxx.up.railway.app/docs
```

**確認項目**:
- [ ] **HTTP 200**: Swagger UI にアクセス可能
- [ ] **エンドポイント一覧**: 全API が表示される
- [ ] **認証スキーム**: Bearer Token 設定済み

### 1.3 データベース接続確認

```bash
# 基本接続テスト
curl -X GET https://pmo-agent-backend-production-xxxx.up.railway.app/api/v1/health/db
```

**期待されるレスポンス**:
```json
{
  "database_status": "connected",
  "tables_count": 5,
  "last_migration": "2024-01-20T09:00:00"
}
```

### 1.4 CORS設定確認

```javascript
// ブラウザコンソールで実行
fetch('https://pmo-agent-backend-production-xxxx.up.railway.app/health', {
  method: 'GET',
  headers: { 'Content-Type': 'application/json' }
})
.then(response => console.log('CORS OK:', response.status))
.catch(error => console.error('CORS Error:', error));
```

**確認項目**:
- [ ] **フロントエンドからAPI呼び出し**: 成功
- [ ] **CORS エラー**: なし
- [ ] **プリフライトリクエスト**: 正常処理

---

## 👤 Phase 2: 認証・ユーザー管理テスト

### 2.1 ユーザー登録機能

#### 新規ユーザー登録

1. https://pmo-agent-frontend.vercel.app にアクセス
2. 「新規登録」をクリック
3. 以下の情報を入力:

```yaml
メールアドレス: test.user.demo@gmail.com
パスワード: TestUser123!@#
パスワード確認: TestUser123!@#
氏名: テスト ユーザー
```

4. 「登録」ボタンをクリック

**期待される動作**:
- [ ] **登録成功**: 「登録が完了しました」メッセージ
- [ ] **自動ログイン**: ダッシュボードへリダイレクト
- [ ] **ユーザー表示**: 右上に「テスト ユーザー」表示

#### API直接テスト

```bash
curl -X POST https://pmo-agent-backend-production-xxxx.up.railway.app/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "api.test.user@gmail.com",
    "password": "ApiTestUser123!",
    "full_name": "API Test User"
  }'
```

**期待されるレスポンス**:
```json
{
  "message": "User created successfully",
  "user_id": "uuid-string",
  "email": "api.test.user@gmail.com"
}
```

### 2.2 ログイン・ログアウト機能

#### ログイン

1. ログアウト（右上メニュー → ログアウト）
2. ログイン画面で以下を入力:

```yaml
メールアドレス: test.user.demo@gmail.com
パスワード: TestUser123!@#
```

3. 「ログイン」をクリック

**期待される動作**:
- [ ] **認証成功**: ダッシュボードへリダイレクト
- [ ] **セッション保持**: ページ更新後もログイン状態維持
- [ ] **トークン保存**: LocalStorage にアクセストークン保存

#### 不正ログイン試行

```bash
curl -X POST https://pmo-agent-backend-production-xxxx.up.railway.app/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test.user.demo@gmail.com",
    "password": "WrongPassword"
  }'
```

**期待されるレスポンス**:
```json
{
  "detail": "Invalid email or password"
}
```

### 2.3 認証保護確認

#### 未認証APIアクセス

```bash
curl -X GET https://pmo-agent-backend-production-xxxx.up.railway.app/api/v1/tasks \
  -H "Content-Type: application/json"
```

**期待されるレスポンス**:
```json
{
  "detail": "Not authenticated"
}
```

#### トークン認証

1. ブラウザでログイン状態のTokenを取得:
   ```javascript
   // ブラウザコンソールで実行
   localStorage.getItem('access_token')
   ```

2. Tokenを使用してAPI呼び出し:
   ```bash
   curl -X GET https://pmo-agent-backend-production-xxxx.up.railway.app/api/v1/tasks \
     -H "Authorization: Bearer YOUR_TOKEN_HERE"
   ```

**期待されるレスポンス**:
```json
{
  "items": [],
  "total": 0,
  "page": 1,
  "size": 50
}
```

---

## 📝 Phase 3: タスク管理機能テスト

### 3.1 タスク作成機能

#### 基本タスク作成

1. ダッシュボードで「新規タスク」をクリック
2. 以下の情報を入力:

```yaml
タイトル: 本番環境テスト - 基本機能確認
説明: |
  本番環境での基本機能テストです。
  以下を確認します：
  - タスクの作成
  - ステータス変更
  - 優先度設定
優先度: 高
期限: 2024-02-01
タグ: テスト, 本番環境
```

3. 「作成」をクリック

**期待される動作**:
- [ ] **作成成功**: タスクがリストに表示
- [ ] **データ保存**: ページ更新後も表示される
- [ ] **表示内容**: 入力した情報が正確に表示
- [ ] **作成者表示**: 「ユーザー作成」バッジ表示

#### 複数タスクの作成

以下のタスクを追加作成:

**タスク2**:
```yaml
タイトル: OpenAI API連携テスト
説明: AI機能の動作確認
優先度: 中
期限: 2024-01-25
```

**タスク3**:
```yaml
タイトル: Microsoft連携テスト
説明: Outlook同期機能の確認
優先度: 高
期限: 2024-01-22
```

### 3.2 タスク操作機能

#### ステータス変更

1. 最初のタスクカードのステータスドロップダウンをクリック
2. 「TODO」→「進行中」に変更

**確認項目**:
- [ ] **ステータス更新**: アイコン・色が変わる
- [ ] **自動保存**: 即座に保存される
- [ ] **UI反映**: 進行中セクションに移動

#### 優先度変更

1. タスクカードの優先度バッジをクリック
2. 「高」→「低」に変更

**確認項目**:
- [ ] **優先度更新**: バッジの色が変わる
- [ ] **ソート順変更**: リスト内での位置が変わる

#### タスク詳細表示

1. タスクカードをクリックして詳細画面を開く
2. 各タブを確認:
   - 概要タブ
   - メール履歴タブ  
   - AI調査タブ

**確認項目**:
- [ ] **詳細情報**: 全ての入力情報が表示
- [ ] **編集機能**: インライン編集が動作
- [ ] **履歴表示**: 変更履歴が記録される

### 3.3 タスク検索・フィルタ

#### 検索機能

1. 検索ボックスに「テスト」と入力
2. 検索結果を確認

**確認項目**:
- [ ] **タイトル検索**: タイトルに「テスト」を含むタスクが表示
- [ ] **説明検索**: 説明に「テスト」を含むタスクも表示
- [ ] **リアルタイム検索**: 入力と同時に結果更新

#### フィルタ機能

1. ステータスフィルタ:「進行中」のみ表示
2. 優先度フィルタ:「高」のみ表示
3. 期日フィルタ:「今週」のみ表示

**確認項目**:
- [ ] **複数フィルタ**: 組み合わせフィルタが動作
- [ ] **フィルタ解除**: 「すべて表示」で元に戻る
- [ ] **カウント表示**: フィルタ結果件数が表示

---

## 🤖 Phase 4: OpenAI連携テスト

### 4.1 AI分析機能

#### タスク分析テスト

1. 「OpenAI API連携テスト」タスクの詳細画面を開く
2. 「AI調査」タブをクリック
3. チャット入力欄に以下を入力:

```
このタスクを効率的に進めるための手順を教えてください。特に、APIの接続確認、レスポンス検証、エラーハンドリングの観点で詳しく説明してください。
```

4. 送信ボタンをクリック

**期待されるレスポンス例**:
```
OpenAI API連携テストを効率的に進める手順：

1. 事前準備フェーズ（10分）
   - API キーの有効性確認
   - 環境変数の設定確認
   - ネットワーク接続確認

2. 基本接続テスト（15分）
   - ヘルスチェックエンドポイントの確認
   - 認証フローの検証
   - 基本的なChat Completions API呼び出し

3. 機能別検証（30分）
   - 各種プロンプトでのレスポンス確認
   - トークン制限の動作確認
   - レート制限の検証

4. エラーハンドリング確認（20分）
   - 無効なAPIキーでのエラー応答
   - ネットワークエラー時の挙動
   - タイムアウト処理の確認

推奨ツール：Postman、curl、ブラウザ開発者ツール
```

**確認項目**:
- [ ] **API接続**: OpenAI API が正常に呼び出される
- [ ] **応答生成**: 関連性の高い回答が生成される
- [ ] **レスポンス時間**: 10秒以内に応答
- [ ] **エラーハンドリング**: API エラー時の適切な表示

#### プロンプトバリエーション

以下の質問も試行:

**質問2**:
```
このタスクのリスクと対策を教えてください
```

**質問3**:  
```
必要なリソースと推定工数を教えてください
```

**確認項目**:
- [ ] **多様な回答**: 質問に応じて異なる回答
- [ ] **日本語対応**: 自然な日本語での回答
- [ ] **文脈理解**: タスク内容を理解した回答

### 4.2 AI使用量監視

#### OpenAI使用状況確認

1. [OpenAI Usage ページ](https://platform.openai.com/usage) にアクセス
2. 本日の使用量を確認

**確認項目**:
- [ ] **トークン消費**: 適切な範囲内（1000トークン程度）
- [ ] **コスト**: $0.01 程度
- [ ] **リクエスト回数**: テスト回数と一致

#### アプリケーション内の使用量表示

ダッシュボードまたは設定画面で使用量確認（実装されている場合）:

**確認項目**:
- [ ] **リクエスト回数**: 正確にカウント
- [ ] **推定コスト**: 概算金額表示
- [ ] **制限警告**: 上限に近づいた際の警告

---

## 📧 Phase 5: Microsoft/Outlook連携テスト

### 5.1 Microsoft アカウント連携

#### OAuth認証フロー

1. 設定画面（右上メニュー → 設定）を開く
2. 「メール連携」セクションを確認
3. 「Microsoft 365」の「連携する」ボタンをクリック

**期待される動作**:
- [ ] **リダイレクト**: Microsoft ログイン画面へ遷移
- [ ] **URL確認**: `login.microsoftonline.com` ドメイン
- [ ] **アプリ表示**: 「PMO Agent」として認識

#### Microsoft 認証

1. テスト用Microsoft アカウントでログイン:
   ```
   アカウント: test.user@outlook.com
   パスワード: [テスト用パスワード]
   ```

2. 権限承認画面で要求される権限を確認:
   - ユーザープロファイルの読み取り
   - メールの読み取り  
   - メールの読み書き
   - オフラインアクセス

3. 「承諾」をクリック

**期待される動作**:
- [ ] **認証成功**: PMO Agent に自動的に戻る
- [ ] **連携完了**: 「連携済み」ステータス表示
- [ ] **ユーザー情報**: Microsoft アカウント情報表示

### 5.2 メール同期テスト

#### テストメールの準備

Outlook.com で以下のメールを作成・送信（自分宛て）:

**メール1: シンプルなタスク**
```
件名: [タスク] 四半期レポート作成
本文:
Q4の四半期レポートを作成してください。

期限: 2024年1月31日
含める内容:
- 売上実績と前年同期比較
- 主要施策の成果
- 来期に向けた課題と提案

よろしくお願いします。
```

**メール2: 緊急度の高いタスク**
```
件名: 【緊急】システム障害対応について  
本文:
本日午後より発生しているシステム障害について、
至急対応をお願いします。

影響範囲: 全社員のメールアクセス
対応期限: 今日中
担当: システム部
```

**メール3: スレッドテスト用**
```
件名: 来月のプロジェクト会議について
本文:
来月のプロジェクト会議の日程調整をしたいと思います。

候補日:
- 2024年2月5日(月) 14:00-15:00
- 2024年2月7日(水) 10:00-11:00  
- 2024年2月9日(金) 15:00-16:00

ご都合をお聞かせください。
```

#### メール同期実行

1. PMO Agent のダッシュボードに戻る
2. 「メール同期」ボタンをクリック
3. 同期進行状況を確認

**期待される動作**:
- [ ] **同期開始**: プログレスバーまたはスピナー表示
- [ ] **進行表示**: 「メールを取得中...」などのメッセージ
- [ ] **完了通知**: 「3件のメールを処理しました」

### 5.3 同期結果の確認

#### 自動生成タスクの確認

タスクリストで以下を確認:

**確認項目**:
- [ ] **タスク1**: 「四半期レポート作成」タスクが作成されている
- [ ] **タスク2**: 「システム障害対応について」タスクが作成されている
- [ ] **優先度自動判定**: 緊急メールが「高」優先度に設定
- [ ] **期限自動抽出**: メール内容から期日が抽出されている
- [ ] **AI作成バッジ**: 「AI作成」表示されている

#### メール履歴の確認

1. 自動生成されたタスクをクリック
2. 「メール履歴」タブを開く

**確認項目**:
- [ ] **元メール表示**: 原文が表示される
- [ ] **送信者情報**: 送信者名・アドレスが表示
- [ ] **受信日時**: 正確な日時が表示
- [ ] **件名**: 元の件名が保持されている

### 5.4 スレッド処理テスト

#### 返信メールの送信

1. メール3「来月のプロジェクト会議について」に返信:

```
件名: Re: 来月のプロジェクト会議について
本文:
2024年2月7日(水) 10:00-11:00 で参加できます。

会議室の予約もお願いします。
また、事前にアジェンダをお送りください。

よろしくお願いします。
```

#### 再同期と確認

1. PMO Agent で再度「メール同期」実行
2. スレッド処理結果を確認

**期待される動作**:
- [ ] **スレッド統合**: 新しいタスクが作成されない
- [ ] **メール追加**: 既存タスクのメール履歴に追加
- [ ] **ステータス更新**: AIがメール内容から状況を判断
- [ ] **タイムライン**: 時系列でメールが整理される

---

## 📊 Phase 6: 統合シナリオテスト

### 6.1 エンドツーエンドワークフロー

#### シナリオ: 新規プロジェクトの立ち上げ

1. **メールでの依頼受信**:
   - Outlook でプロジェクト依頼メールを送信
   - PMO Agent で自動的にタスク作成

2. **AI による初期分析**:
   - 生成されたタスクでAI分析実行
   - プロジェクト計画の提案を取得

3. **手動でのタスク調整**:
   - AI提案を基にタスクを分割
   - 各タスクに期限と優先度を設定

4. **進捗管理**:
   - タスクステータスを更新
   - 関連メールの継続的な同期

**確認項目**:
- [ ] **ワークフロー完走**: エラーなく全工程完了
- [ ] **データ整合性**: 各段階でデータが正確に保持
- [ ] **ユーザー体験**: 直感的で効率的な操作感

### 6.2 負荷テスト（軽量）

#### 複数タスク同時作成

```bash
# 10個のタスクを同時作成
for i in {1..10}; do
  curl -X POST https://pmo-agent-backend-production-xxxx.up.railway.app/api/v1/tasks \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "{
      \"title\": \"負荷テストタスク $i\",
      \"description\": \"負荷テスト用のタスクです\",
      \"priority\": \"medium\"
    }" &
done
wait
```

#### 同時AI分析リクエスト

ブラウザで複数タブを開き、同時にAI分析を実行

**確認項目**:
- [ ] **レスポンス時間**: 各リクエスト15秒以内
- [ ] **エラー率**: 5%以下
- [ ] **データ整合性**: 全タスクが正確に作成

---

## 🔍 Phase 7: セキュリティ・エラーハンドリング

### 7.1 セキュリティテスト

#### 認証バイパス試行

```bash
# 無効なトークンでアクセス試行
curl -X GET https://pmo-agent-backend-production-xxxx.up.railway.app/api/v1/tasks \
  -H "Authorization: Bearer invalid_token"

# 期限切れトークンでアクセス試行  
curl -X GET https://pmo-agent-backend-production-xxxx.up.railway.app/api/v1/tasks \
  -H "Authorization: Bearer expired_token"
```

**期待される応答**:
```json
{
  "detail": "Could not validate credentials"
}
```

#### 他ユーザーのデータアクセス試行

1. 別のユーザーアカウントでログイン
2. 最初のユーザーのタスクIDを使用してアクセス試行

**確認項目**:
- [ ] **アクセス拒否**: 403 Forbidden エラー
- [ ] **データ漏洩なし**: 他ユーザーのデータが表示されない

### 7.2 エラーハンドリング

#### ネットワークエラー

1. ブラウザの開発者ツールで「Offline」に設定
2. タスク作成を試行

**期待される動作**:
- [ ] **エラー表示**: 「ネットワークエラー」メッセージ
- [ ] **リトライ機能**: 「再試行」ボタン表示
- [ ] **データ保持**: 入力内容が保持される

#### API制限テスト

OpenAI API のレート制限に近づく状況をシミュレート:

1. 短時間で多数のAI分析リクエストを送信
2. エラーハンドリングを確認

**期待される動作**:
- [ ] **制限メッセージ**: 「一時的に利用制限中」表示
- [ ] **自動リトライ**: 一定時間後に自動再試行
- [ ] **ユーザー通知**: 適切な説明メッセージ

---

## 📋 テスト結果記録

### テスト完了チェックリスト

#### ✅ 基盤機能

- [ ] フロントエンド表示・動作
- [ ] バックエンドAPI応答
- [ ] データベース接続
- [ ] CORS設定

#### ✅ 認証・ユーザー管理

- [ ] ユーザー登録
- [ ] ログイン・ログアウト
- [ ] 認証保護
- [ ] セッション管理

#### ✅ タスク管理

- [ ] タスク作成・編集・削除
- [ ] ステータス変更
- [ ] 検索・フィルタ
- [ ] 詳細表示

#### ✅ OpenAI連携

- [ ] AI分析機能
- [ ] APIエラーハンドリング
- [ ] 使用量監視
- [ ] レスポンス品質

#### ✅ Microsoft連携

- [ ] OAuth認証
- [ ] メール同期
- [ ] スレッド処理
- [ ] 自動タスク生成

#### ✅ セキュリティ

- [ ] 認証バイパス防止
- [ ] データアクセス制御
- [ ] エラーハンドリング
- [ ] 入力値検証

### パフォーマンス結果

| 指標 | 目標値 | 実測値 | 結果 |
|------|--------|--------|------|
| ページ読み込み | < 3秒 | ___秒 | ✅/❌ |
| API応答時間 | < 1秒 | ___秒 | ✅/❌ |
| AI分析応答 | < 15秒 | ___秒 | ✅/❌ |
| メール同期 | < 30秒 | ___秒 | ✅/❌ |

### 発見された問題

```markdown
## 問題1: [問題の概要]
**重要度**: High/Medium/Low
**再現手順**: 
1. 
2. 
3. 

**期待される動作**: 
**実際の動作**: 
**スクリーンショット**: [添付]
**対策**: 

## 問題2: [問題の概要]
...
```

---

## 🎯 テスト完了後のアクション

### 即座に実施

1. **問題の修正**: 発見された Critical/High レベルの問題
2. **セキュリティ強化**: 脆弱性が見つかった場合の対策
3. **パフォーマンス改善**: 目標値を下回った項目の最適化

### 今後の改善

1. **ユーザビリティ向上**: テスト中に気づいたUI/UXの改善点
2. **機能拡張**: テスト中に要求された追加機能
3. **監視体制**: 本番運用に向けたモニタリング設定

### 運用開始準備

1. **ユーザーガイド**: 実際の操作に基づくマニュアル作成
2. **サポート体制**: よくある問題と解決方法の整理
3. **定期メンテナンス**: バックアップとアップデート計画

---

**テスト完了予定時間**: 90分
**合格基準**: Critical問題0件、High問題2件以下
**次のアクション**: [運用開始](./11-production-operations.md) または [問題修正](./05-troubleshooting.md)

May the Force be with you.