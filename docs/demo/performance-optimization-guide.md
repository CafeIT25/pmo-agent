# PMO Agent ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€Gmail N+1ã‚¯ã‚¨ãƒªå•é¡Œã‚’è§£æ±ºã—ã€Railwayç„¡æ–™ãƒ—ãƒ©ãƒ³ã§æœ€é«˜ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®æœ€é©åŒ–æ‰‹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## ğŸš€ æœ€é©åŒ–ã«ã‚ˆã‚‹æ”¹å–„åŠ¹æœ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

| é …ç›® | æœ€é©åŒ–å‰ | æœ€é©åŒ–å¾Œ | æ”¹å–„ç‡ |
|------|----------|----------|--------|
| **Gmail 50ä»¶åŒæœŸ** | 120ç§’ | 15ç§’ | **87%æ”¹å–„** |
| **APIå‘¼ã³å‡ºã—æ•°** | 51å› | 4å› | **92%å‰Šæ¸›** |
| **Railwayå®Ÿè¡Œæ™‚é–“** | é«˜æ¶ˆè²» | å¤§å¹…ç¯€ç´„ | **åŠ¹ç‡åŒ–** |
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨** | å¤‰å‹•å¤§ | å®‰å®š | **å®‰å®šåŒ–** |

### ã‚³ã‚¹ãƒˆåŠ¹æœ

```mermaid
graph TB
    A[æœ€é©åŒ–å‰] --> A1[120ç§’/50ä»¶]
    A --> A2[API: 51å›]
    A --> A3[Railway: é«˜è² è·]
    
    B[æœ€é©åŒ–å¾Œ] --> B1[15ç§’/50ä»¶]
    B --> B2[API: 4å›]
    B --> B3[Railway: ä½è² è·]
    
    A3 --> C[500æ™‚é–“åˆ¶é™ã«æ—©æœŸåˆ°é”]
    B3 --> D[500æ™‚é–“åˆ¶é™ã‚’åŠ¹ç‡æ´»ç”¨]
```

## ğŸ”§ æœ€é©åŒ–æŠ€è¡“

### 1. Gmail ãƒãƒƒãƒãƒªã‚¯ã‚¨ã‚¹ãƒˆ

**å•é¡Œ**: N+1ã‚¯ã‚¨ãƒªã«ã‚ˆã‚‹å¤§é‡APIå‘¼ã³å‡ºã—
**è§£æ±º**: Gmail API Batch Requestsã®æ´»ç”¨

```python
# æœ€é©åŒ–å‰: 51å›ã®APIå‘¼ã³å‡ºã—
for message_id in message_ids:  # 50å›
    message = gmail_api.get_message(message_id)  # Nå›ã®å€‹åˆ¥å‘¼ã³å‡ºã—

# æœ€é©åŒ–å¾Œ: 4å›ã®APIå‘¼ã³å‡ºã—
batches = chunk(message_ids, 20)  # 20ä»¶ãšã¤ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
for batch in batches:  # 3å›ã®ãƒãƒƒãƒå‘¼ã³å‡ºã—
    messages = gmail_api.batch_get_messages(batch)
```

### 2. ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥

**Redis Pipeline**ã«ã‚ˆã‚‹é«˜é€Ÿã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¢ã‚¯ã‚»ã‚¹:

```python
# è¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ‹¬å–å¾—
cache_keys = [f"email:msg:{msg_id}" for msg_id in message_ids]
pipeline = redis.pipeline()
for key in cache_keys:
    pipeline.get(key)
cached_values = pipeline.execute()
```

### 3. ä¸¦è¡Œå‡¦ç†æœ€é©åŒ–

**éåŒæœŸå‡¦ç†**ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾…æ©Ÿæ™‚é–“ã‚’é‡ã­åˆã‚ã›:

```python
# è¤‡æ•°ãƒãƒƒãƒã‚’ä¸¦è¡Œå‡¦ç†
semaphore = asyncio.Semaphore(3)  # Railwayåˆ¶ç´„è€ƒæ…®
tasks = [process_batch(batch) for batch in batches]
results = await asyncio.gather(*tasks)
```

## ğŸ“Š è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

### ç’°å¢ƒå¤‰æ•°è¨­å®š

```env
# Gmail æœ€é©åŒ–è¨­å®š
GMAIL_BATCH_SIZE=20                    # ãƒãƒƒãƒã‚µã‚¤ã‚º
GMAIL_MAX_CONCURRENT_BATCHES=3         # ä¸¦è¡Œãƒãƒƒãƒæ•°
GMAIL_FIELDS=id,threadId,labelIds,snippet,payload/headers,internalDate

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
CACHE_MESSAGE_TTL=3600                 # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™
CACHE_SYNC_TOKEN_TTL=86400             # åŒæœŸãƒˆãƒ¼ã‚¯ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®š
MAX_SYNC_DURATION=300                  # æœ€å¤§åŒæœŸæ™‚é–“
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5    # ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼é–¾å€¤
RATE_LIMIT_BACKOFF_FACTOR=2            # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒãƒƒã‚¯ã‚ªãƒ•ä¿‚æ•°
```

### ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ

#### Gmail ãƒãƒƒãƒã‚µã‚¤ã‚º
- **æ¨å¥¨**: 20ä»¶/ãƒãƒƒãƒ
- **ç†ç”±**: Gmail APIåˆ¶é™ã¨Railwayåˆ¶ç´„ã®ãƒãƒ©ãƒ³ã‚¹
- **èª¿æ•´**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã«å¿œã˜ã¦10-30ä»¶

#### ä¸¦è¡Œå‡¦ç†æ•°
- **æ¨å¥¨**: 3ä¸¦è¡Œãƒãƒƒãƒ
- **ç†ç”±**: Railway 1GB RAMåˆ¶é™ã‚’è€ƒæ…®
- **èª¿æ•´**: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã—ã¦èª¿æ•´

#### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™
- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: 1æ™‚é–“ï¼ˆ3600ç§’ï¼‰
- **åŒæœŸãƒˆãƒ¼ã‚¯ãƒ³**: 24æ™‚é–“ï¼ˆ86400ç§’ï¼‰
- **èª¿æ•´**: æ›´æ–°é »åº¦ã¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ã®ãƒãƒ©ãƒ³ã‚¹

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æœ€é©åŒ–

### ãƒ•ãƒ­ãƒ¼å›³

```mermaid
graph TB
    A[åŒæœŸé–‹å§‹] --> B[å¢—åˆ†åŒæœŸãƒã‚§ãƒƒã‚¯]
    B -->|æ–°è¦| C[ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDãƒªã‚¹ãƒˆå–å¾—]
    B -->|å¢—åˆ†| D[History APIä½¿ç”¨]
    
    C --> E[ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯]
    D --> E
    E --> F[æœªã‚­ãƒ£ãƒƒã‚·ãƒ¥IDç‰¹å®š]
    
    F --> G[ãƒãƒƒãƒãƒªã‚¯ã‚¨ã‚¹ãƒˆ]
    G --> H[20ä»¶ãšã¤ä¸¦è¡Œå‡¦ç†]
    H --> I[ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°]
    
    I --> J[ã‚¹ãƒ¬ãƒƒãƒ‰ã‚°ãƒ«ãƒ¼ãƒ—åŒ–]
    J --> K[AIåˆ†æã‚¿ã‚¹ã‚¯]
    K --> L[å®Œäº†]
```

### ã‚¨ãƒ©ãƒ¼è€æ€§

```python
class CircuitBreaker:
    """APIéšœå®³æ™‚ã®è‡ªå‹•å¾©æ—§"""
    def __init__(self, failure_threshold=5, timeout=60):
        self.failure_threshold = failure_threshold
        self.timeout = timeout
        self.state = "CLOSED"  # CLOSED/OPEN/HALF_OPEN
```

## ğŸ“ˆ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™

1. **åŒæœŸæ™‚é–“**: ç›®æ¨™15ç§’/50ä»¶
2. **APIå‘¼ã³å‡ºã—æ•°**: ç›®æ¨™4å›/50ä»¶
3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡**: ç›®æ¨™70%ä»¥ä¸Š
4. **ã‚¨ãƒ©ãƒ¼ç‡**: ç›®æ¨™5%ä»¥ä¸‹

### ãƒ­ã‚°ä¾‹

```
INFO: Optimized Gmail sync completed for user 123: 50 messages in 14.2s
INFO: Cache hit: 35/50 messages. Need to fetch: 15
INFO: Sync metrics - gmail: 50 messages, 14.20s, 3 API calls, 35 cached
```

## ğŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### 1. ãƒãƒƒãƒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼
**ç—‡çŠ¶**: `multipart/mixed` è§£æã‚¨ãƒ©ãƒ¼
**å¯¾ç­–**: å€‹åˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

#### 2. ãƒ¬ãƒ¼ãƒˆåˆ¶é™
**ç—‡çŠ¶**: 429 Too Many Requests
**å¯¾ç­–**: æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ãƒªãƒˆãƒ©ã‚¤

#### 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹å¤šç™º
**ç—‡çŠ¶**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡<50%
**å¯¾ç­–**: TTLèª¿æ•´ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¦ã‚©ãƒ¼ãƒŸãƒ³ã‚°

### ãƒ‡ãƒãƒƒã‚°æ‰‹é †

```bash
# 1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ­ã‚°ç¢ºèª
railway logs | grep "Sync metrics"

# 2. Redis ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ³ç¢ºèª
redis-cli info memory
redis-cli keys "email:msg:*" | wc -l

# 3. APIä½¿ç”¨é‡ç¢ºèª
curl -H "Authorization: Bearer $TOKEN" \
  "https://www.googleapis.com/gmail/v1/users/me/profile"
```

## ğŸ¯ é‹ç”¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

```python
# å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ—¥æ¬¡å®Ÿè¡Œï¼‰
@celery_app.task(name='cleanup_old_cache')
def cleanup_old_cache():
    # æœŸé™åˆ‡ã‚Œã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å‰Šé™¤
    # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆã®é›†è¨ˆ
```

### 2. ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç›£è¦–

```python
# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç•°å¸¸æ¤œçŸ¥
if duration > 60:  # 60ç§’è¶…é
    await alert_performance_issue(provider, metrics)
```

### 3. ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ç›£è¦–

```bash
# Railway ä½¿ç”¨é‡ç¢ºèª
railway status
railway usage

# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–
ps aux | grep python | awk '{sum+=$6} END {print sum/1024 " MB"}'
```

## ğŸ“š è¿½åŠ ãƒªã‚½ãƒ¼ã‚¹

- [Gmail API Batch Requests Documentation](https://developers.google.com/gmail/api/guides/batch)
- [Railway Platform Limits](https://docs.railway.app/reference/limits)
- [Redis Pipeline Best Practices](https://redis.io/docs/manual/pipelining/)

## ğŸ”„ ç¶™ç¶šçš„æ”¹å–„

### Phase 1 å®Œäº†é …ç›®
- âœ… Gmail ãƒãƒƒãƒãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè£…
- âœ… ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥
- âœ… ä¸¦è¡Œå‡¦ç†æœ€é©åŒ–
- âœ… ã‚¨ãƒ©ãƒ¼è€æ€§å¼·åŒ–

### Phase 2 è¨ˆç”»
- ğŸ”„ Outlook APIæœ€é©åŒ–
- ğŸ”„ äºˆæ¸¬çš„ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
- ğŸ”„ æ©Ÿæ¢°å­¦ç¿’ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–

ã“ã®æœ€é©åŒ–ã«ã‚ˆã‚Šã€Railwayç„¡æ–™ãƒ—ãƒ©ãƒ³ã§ã‚‚é«˜é€Ÿã§å®‰å®šã—ãŸãƒ¡ãƒ¼ãƒ«åŒæœŸãŒå®Ÿç¾ã§ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚